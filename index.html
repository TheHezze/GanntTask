<!DOCTYPE html>
<html>
<head>
    <title>CTRL Gantt</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <style>
        .bar {
            fill: steelblue;
            stroke: none;
        }
        .bar:hover {
            fill: lightsteelblue;
            stroke: orange;
            stroke-width: 2px;
        }
        .axis text {
            font: 10px sans-serif;
        }
        .row-bg {
            fill: none;
            stroke: lightgray;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            width: 150px; /* Increased width for longer text */
            height: auto; /* Adjust height automatically */
            padding: 5px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
        }
        .current-date {
            text-align: center;
            font-size: 20px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .nav-button {
            cursor: pointer;
            font-size: 24px;
            margin: 0 10px;
        }
        #datePicker, #dayRange, #searchBar {
            margin-left: 10px;
            font-size: 18px;
            height: 40px;
        }
        .day-label {
            font-size: 12px;
            text-anchor: middle;
        }
        .date-label {
            font-size: 12px;
            text-anchor: middle;
            fill: black; /* Set color for day of month labels */
        }
        #chartContainer {
            height: 500px; /* Set a fixed height for the chart container */
            overflow-y: auto; /* Enable vertical scrolling */
            border: 1px solid lightgray; /* Optional: border for better visibility */
        }
    </style>
</head>
<body>
    <div class="current-date" id="currentDate">
        <input type="text" id="searchBar" placeholder="Search SKU" oninput="filterData()" style="margin-right: 10px;">
        <span class="nav-button" onclick="changeDay(-1)">&#9664;</span>
        <input type="date" id="datePicker" onchange="selectDate()">
        <span class="nav-button" onclick="changeDay(1)">&#9654;</span>
        <select id="dayRange" onchange="selectDate()">
            <option value="2">2 Days Ahead</option>
            <option value="5">5 Days Ahead</option>
            <option value="10">10 Days Ahead</option>
            <option value="15">15 Days Ahead</option>
            <option value="30" selected>30 Days Ahead</option>
        </select>
    </div>
    
    <div id="chartContainer">
        <svg id="chart" width="100%" height="800"></svg>
    </div>

    <script>
        var margin = {top: 70, right: 20, bottom: 30, left: 100},
            width = window.innerWidth - margin.left - margin.right,
            height = 800 - margin.top - margin.bottom;

        var x = d3.scaleTime().range([0, width]),
            y = d3.scaleBand().range([0, height]).padding(0.2);

        var svg = d3.select("#chart")
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var xAxis = d3.axisBottom(x)
            .ticks(d3.timeDay.every(1))
            .tickFormat(d3.timeFormat("%d %b"));
        var yAxis = d3.axisLeft(y).tickSize(0);

        var data;
        var currentDay = new Date();

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById("datePicker").value = d3.timeFormat("%Y-%m-%d")(currentDay);
        });

        var color;
        var div = d3.select("body").append("div").attr("class", "tooltip").style("opacity", 0);

        d3.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vT4-N90ix_krBo8W3AAdcmUfGizjpBKNMQXhHSOKpEg3kZngWgz1F57nl5gXRAPHiK-MUMPTHH55ehS/pub?output=csv").then(function(contents) {
            var parseTime = d3.timeParse("%m/%d/%Y %H:%M");
            var parseTimeWithAMPM = d3.timeParse("%m/%d/%Y %I:%M %p");

            data = contents.map(function(d) {
                return {
                    id: d['Event ID'],
                    name: d['Item SKU'],
                    start: d['Start Date'] ? parseTime(d['Start Date']) || parseTimeWithAMPM(d['Start Date']) : null,
                    end: d['End Date'] ? parseTime(d['End Date']) || parseTimeWithAMPM(d['End Date']) : null
                };
            });

            const uniqueEventIds = Array.from(new Set(data.map(d => d.id)));
            color = d3.scaleOrdinal(d3.schemeCategory10).domain(uniqueEventIds);

            drawChart(data);
        });

        function filterData() {
            const searchText = document.getElementById("searchBar").value.toLowerCase();
            const filteredData = data.filter(d => d.name.toLowerCase().includes(searchText));
            drawChart(filteredData);
        }

        function drawChart(dataToDisplay) {
            svg.selectAll("*").remove();

            var selectedDate = new Date(document.getElementById("datePicker").value);
            var daysAhead = parseInt(document.getElementById("dayRange").value);
            var endDate = new Date(selectedDate);
            endDate.setDate(endDate.getDate() + daysAhead);

            var filteredData = dataToDisplay.filter(d => {
                return (d.start && d.start > selectedDate) || (d.end && d.end >= selectedDate);
            });

            if (filteredData.length === 0) {
                svg.append("text").attr("x", width / 2).attr("y", height / 2).attr("text-anchor", "middle").text("No entries after the selected date.").style("font-size", "16px");
                return;
            }

            var startDate = new Date(Math.min(...filteredData.map(d => d.start)));
            var adjustedEndDate = endDate < new Date(Math.max(...filteredData.map(d => d.end || currentDay))) ? endDate : new Date(Math.max(...filteredData.map(d => d.end || currentDay)));

            x.domain([startDate, adjustedEndDate]);
            y.domain(filteredData.map(d => d.name));

            svg.append("g").attr("transform", "translate(0," + height + ")").call(xAxis).call(g => g.select(".domain").remove());
            svg.append("g").call(yAxis).call(g => g.select(".domain").remove());

            // Add day of month labels (1-31) above the day of week labels
            for (let dt = new Date(startDate); dt <= adjustedEndDate; dt.setDate(dt.getDate() + 1)) {
                svg.append("text")
                    .attr("class", "date-label")
                    .attr("x", x(dt) + (x(new Date(dt.getTime() + 1 * 24 * 60 * 60 * 1000)) - x(dt)) / 2)
                    .attr("y", -20) // Position higher above the day labels
                    .text(d3.timeFormat("%d")(dt)); // Day of the month
            }

            // Add day labels (Mon-Sun) at the top of the chart
            for (let dt = new Date(startDate); dt <= adjustedEndDate; dt.setDate(dt.getDate() + 1)) {
                svg.append("text")
                    .attr("class", "day-label")
                    .attr("x", x(dt) + (x(new Date(dt.getTime() + 1 * 24 * 60 * 60 * 1000)) - x(dt)) / 2)
                    .attr("y", 0) // Position just below the day of month labels
                    .text(d3.timeFormat("%a")(dt)); // Abbreviated day name
            }

            svg.selectAll(".row-bg")
                .data(y.domain())
                .enter().append("rect")
                .attr("class", "row-bg")
                .attr("x", 0)
                .attr("y", (d, i) => y(d))
                .attr("width", width)
                .attr("height", y.bandwidth())
                .attr("fill", (d, i) => i % 2 ? "#eee" : "#fff");

            svg.selectAll(".bar")
                .data(filteredData)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.start))
                .attr("y", d => y(d.name))
                .attr("width", d => x(d.end || new Date()) - x(d.start))
                .attr("height", y.bandwidth())
                .attr("rx", 5)
                .attr("fill", d => color(d.id))
                .on("mouseover", function(event, d) {
                    div.transition().duration(200).style("opacity", .9);
                    div.html(
                        `<strong>Item SKU: ${d.name}</strong><br/>` + 
                        `End Date: ${d.end ? d3.timeFormat("%B %d, %I:%M %p")(d.end) : "Ongoing"}<br/>` + 
                        `Event ID: ${d.id}`
                    )
                    .style("left", (event.pageX + 5) + "px")
                    .style("top", (event.pageY - 40) + "px");
                })
                .on("mouseout", function(d) {
                    div.transition().duration(500).style("opacity", 0);
                });

            // Draw vertical grid lines for each day and highlight weekends
            for (let dt = startDate; dt <= adjustedEndDate; dt.setDate(dt.getDate() + 1)) {
                svg.append("line")
                    .attr("x1", x(new Date(dt)))
                    .attr("y1", 0)
                    .attr("x2", x(new Date(dt)))
                    .attr("y2", height)
                    .attr("stroke", "lightgray")
                    .attr("stroke-width", 1)
                    .attr("stroke-dasharray", "2,2");

                if (dt.getDay() === 0 || dt.getDay() === 6) {
                    svg.append("rect")
                        .attr("x", x(new Date(dt)))
                        .attr("y", 0)
                        .attr("width", x(new Date(dt.getTime() + 1 * 24 * 60 * 60 * 1000)) - x(new Date(dt)))
                        .attr("height", height)
                        .attr("fill", "rgba(255, 223, 186, 0.5)");
                }
            }
        }

        function changeDay(direction) {
            currentDay.setDate(currentDay.getDate() + direction);
            document.getElementById("datePicker").value = d3.timeFormat("%Y-%m-%d")(currentDay);
            drawChart(data);
        }

        function selectDate() {
            drawChart(data);
        }
    </script>
</body>
</html>
